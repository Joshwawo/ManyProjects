import axios from "axios";
import voicesModel from "../models/voicesModel";

type bodyVoices = {
  tts: string | undefined;
  voice: string;
  pace: number;
  duration: number; //TODO: cambiar a array de numeros
  pitch: number;
  voicemodel_uuid: string;
};

interface VoicesGet {
  failed_at: string | null;
  finished_at: string | null;
  meta: string | null;
  path: string | null;
  started_at: string | null;
  uuid: string | null;
  tts: string | undefined;
}

// Generated by https://quicktype.io

export interface ResVoicesTypes {
  controls: boolean;
  display_name: string;
  is_active: boolean;
  model_id: string;
  memberships: any[];
  is_private: boolean;
  is_primary: boolean;
  name: string;
  symbol_set: string;
  voicemodel_uuid: string;
  hifi_gan_vocoder: string;
  ml_model_id: number;
  speaker_id: null;
  language: string;
}

const listVoicesServices = async (language: any, mode: string) => {
  let realUrl;
  realUrl = `https://api.uberduck.ai/voices?mode=${mode}`;
  if (language === "undefined") {
    realUrl = `https://api.uberduck.ai/voices?mode=${mode}`;
  } else {
    realUrl = `https://api.uberduck.ai/voices?mode=${mode}&language=${language}`;
  }
  const options = {
    method: "GET",
    url: realUrl,
    headers: {
      accept: "application/json",
      authorization: `Basic ${process.env.API_KEY_UBERDUCK}`,
    },
  };
  try {
    const response = await axios.request(options);
    let result = response.data as ResVoicesTypes[];

    return result;

    // return filterR;
  } catch (error) {
    console.log(error);
  }
};

const listVoicesServicesHelper = async (language: any, mode: string) => {
  let realUrl;
  realUrl = `https://api.uberduck.ai/voices?mode=${mode}`;
  if (language === "undefined") {
    realUrl = `https://api.uberduck.ai/voices?mode=${mode}`;
  } else {
    realUrl = `https://api.uberduck.ai/voices?mode=${mode}&language=${language}`;
  }
  const options = {
    method: "GET",
    url: realUrl,
    headers: {
      accept: "application/json",
      authorization: `Basic ${process.env.API_KEY_UBERDUCK}`,
    },
  };
  try {
    const response = await axios.request(options);
    let result = response.data as ResVoicesTypes[];
    let languagesNameAndLang = result.map((item, index) => {
      return {
        displayName: item.display_name,
        name: item.name,
      };
    });
    return languagesNameAndLang;

    // return filterR;
  } catch (error) {
    console.log(error);
  }
};

const resSpeechServices = async (body: bodyVoices) => {
  const { tts, voice, pace, duration, pitch, voicemodel_uuid } = body;
  const postSpeech = async () => {
    const options = {
      method: "POST",
      url: "https://api.uberduck.ai/speak",
      headers: {
        accept: "application/json",
        "uberduck-id": "anonymous",
        "content-type": "application/json",
        authorization: `Basic ${process.env.API_KEY_UBERDUCK}`,
      },
      data: {
        voice: voice,
        pace: 100,
        speech: tts,
        // duration: [100],
        // pitch: [100],
        // voicemodel_uuid: voicemodel_uuid,
      },
    };
    try {
      const response = await axios.request(options);
      return {
        res: response.data,
        tss: tts,
      };
    } catch (error) {
      // console.error(error);
      const newError = new Error("Error with the request to the API");
      throw newError;
    }
  };

  //!OBTENGO LA VOZ DEL POST DE SPEECH
  const getSpeech = async (uuid: string | null, tss: string | undefined) => {
    // let resultTss ='By default, ReactPlayer supports many different types of url. If you only ever use one type, use imports such as react-player/youtube to reduce your bundle size. See config keys for all player keys.'
    const url = `https://api.uberduck.ai/speak-status?uuid=${uuid}`;
    const response = await axios.get(url, {
      headers: { accept: "application/json" },
    });
    const res = response.data;
    response.data.tss = tss;

    return res;
  };

  try {
    const respuestaPost: any = await postSpeech();

    const uuid = respuestaPost?.res?.uuid;
    const tss = respuestaPost?.tss;

    let respuestaGet;

    return new Promise((resolve, reject) => {
      setTimeout(async () => {
        respuestaGet = await getSpeech(uuid, tss);
        let datasaved: VoicesGet = {
          failed_at: respuestaGet.failed_at,
          finished_at: respuestaGet.finished_at,
          meta: respuestaGet.meta,
          path: respuestaGet.path,
          started_at: respuestaGet.started_at,
          uuid: uuid,
          tts: respuestaPost?.tss,
        };
        const voices = new voicesModel(datasaved);
        await voices.save();
        // const voicesSaved =

        resolve(respuestaGet);
      }, 9000);
    });
  } catch (error) {
    console.log(error);
    const errorResponse = new Error("Error with the request to the API, try again");

    return errorResponse;
  }
};

const testo = async () => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve("Hola desde testo");
    }, 10000);
  });
};

export {
  resSpeechServices,
  testo,
  listVoicesServices,
  listVoicesServicesHelper,
};

//   setTimeout(async () => {
//     //you have better options than this?
//     respuestaGet = await getSpeech(uuid);
//     console.log(respuestaGet);
//     // como puedo retornar el valor de respuestaGet?
//     // return respuestaGet
//     return respuestaGet;
//   }, 5000);
//   return new Promise((resolve, reject) => {
//     const interval = setInterval(async () => {
//       respuestaGet = await getSpeech(uuid);
//       console.log(uuid + "Desde la linea 58");
//       console.log(respuestaGet);

//       if (respuestaGet === "done") {
//         clearInterval(interval);
//         resolve(respuestaGet);
//       }
//     }, 5000);
//   });

//   como puedo retornar el valor de respuestaGet?
